#' All in once for tabular
#'
#' @inheritParams tab_rda
#' @inheritParams tab_arb
#' @inheritParams run_arb
#'
#' @param files_name string used to name all the files needed to process.
#' All files will have the same name, only their extension will be different.
#' @param dir_name string indicated the path of the directory in which to save
#' all the files (.rda, .hst, .txt, .arb, .csv) generated by the function.
#' @param unif_labels boolean, if explanatory variables have to be standardized
#' @param split_tab boolean, wether to reduce dimension to 3 when treating a table
#' of dimension 4 or 5
#' @param LIMIT numeric, used to choose which variable to merge (if nb_tab = 'smart')
#' and split table with a number of row above this limit in order to avoid
#' tauargus failures
#' @param nb_tab strategy to choose the variable to merge :
#' 'min' : minimize the number of tables generated (tables are bigger)
#' 'max' : maximize the number of the tables générated
#' (tables are smaller tauargus process may take a long time)
#' 'smart' : minimize the number of tables generated taking into account
#' a maximum number of row below LIMIT
#' @param ... any parameter of the tab_rda, tab_arb or run_arb functions, relevant
#' for the treatment of tabular.
#'
#' @return
#' If output_type equals to 4, then the original tabular is returned with a new
#' column called Status, indicating the status of the cell coming from Tau-Argus :
#' "A" for a primary secret due to frequency rule, "B" for a primary secret due
#' to dominance rule, "D" for secondary secret and "V" for no secret cell.
#'
#' If output_type doesn't equal to 4, then the raw result from tau-argus is returned.
#'
#' @section Standardization of explanatory variables and hierarchies:
#'
#' The boolean argument \code{unif_labels} is useful to
#' prevent some common errors in using Tau-Argus. Indeed, Tau-Argus needs that,
#' within a same level of a hierarchy, the labels have the same number of
#' characters. When the argument is set to TRUE, \code{tab_rtauargus}
#' standardizes the explanatory variables to prevent this issue.
#' Hierarchical explanatory variables (explanatory variables associated to
#' a hrc file) are then modified in the tabular data and an another hrc file is
#' created to be relevant with the tabular. In the output, these modifications
#' are removed.
#'
#' @examples
#'\dontrun{
#' library(dplyr)
#' library(stringr)
#' data(turnover_act_size)
#'
#' # Prepare data with primary secret ----
#' turnover_act_size <- turnover_act_size %>%
#'   mutate(
#'     is_secret_freq = N_OBS > 0 & N_OBS < 3,
#'     is_secret_dom = ifelse(MAX == 0, FALSE, MAX/TOT>0.85),
#'     is_secret_prim = is_secret_freq | is_secret_dom
#'   )
#'
#' # Make hrc file of business sectors ----
#' data(activity_corr_table)
#' hrc_file_activity <- activity_corr_table %>%
#'   write_hrc2(file_name = "hrc/activity")
#'
#' # Compute the secondary secret ----
#' options(
#'   rtauargus.tauargus_exe =
#'     "Y:/Logiciels/TauArgus/TauArgus4.2.2b1/TauArgus.exe"
#' )
#'
#' res <- tab_rtauargus(
#'   tabular = turnover_act_size,
#'   files_name = "turn_act_size",
#'   dir_name = "tauargus_files",
#'   explanatory_vars = c("ACTIVITY", "SIZE"),
#'   hrc = c(ACTIVITY = hrc_file_activity),
#'   totcode = c(ACTIVITY = "Total", SIZE = "Total"),
#'   secret_var = "is_secret_prim",
#'   value = "TOT",
#'   freq = "N_OBS",
#'   verbose = FALSE
#' )
#'
#' # Reduce dims feature
#' load("donnees/ca_test_0_hrc.RData")
#'
#' res_all_dtp <- res_all_dtp %>%
#'   mutate(
#'     is_secret_freq = nb_obs > 0 & nb_obs < 3,
#'     is_secret_dom = ifelse(pizzas_max == 0, FALSE, pizzas_max/pizzas_tot>0.85),
#'     is_secret_prim = is_secret_freq | is_secret_dom,
#'     nb_obs = ceiling(nb_obs),
#'     pizzas_tot=abs(pizzas_tot)
#'   )
#'
#' res_dim4 <- tab_rtauargus(
#'   tabular = res_all_dtp,
#'   files_name = "ca_test_0_hrc",
#'   dir_name = "ca_test_0_hrc",
#'   explanatory_vars = c("A10", "treff","type_distrib","cj"),
#'   totcode = c(A10 = "Total", treff = "Total",type_distrib = "Total",cj = "Total"),
#'   secret_var = "is_secret_prim",
#'   value = "pizzas_tot",
#'   freq = "nb_obs",
#'   nb_tab = "smart",
#'   split_tab = TRUE,
#'   LIMIT = 400
#' )
#' }
#' @export
tab_rtauargus <- function(
    tabular,
    files_name = NULL,
    dir_name = NULL,
    explanatory_vars,
    totcode = getOption("rtauargus.totcode"),
    hrc = NULL,
    secret_var = NULL,
    secret_no_pl = NULL,
    cost_var = NULL,
    value = "value",
    freq = "freq",
    ip = 10,
    maxscore = NULL,
    suppress = "MOD(1,5,1,0,0)",
    safety_rules = paste0("MAN(",ip,")"),
    show_batch_console = FALSE,
    output_type = 4,
    output_options = "",
    unif_labels = TRUE,
    split_tab = FALSE,
    LIMIT = 14700,
    nb_tab = "smart",
    ...
){

  .dots <- list(...)

  ## 0. CONFLITS PARAMETRES .................

  # tabular not a data.frame
  if(!is.data.frame(tabular)){
    stop("tabular has to be a dataframe.")
  }
  if(any(!explanatory_vars %in% names(tabular))){
    stop("At least one of the explanatory vars is not a tabular's column name")
  }
  if(any(!c(value, freq) %in% names(tabular))){
    stop(paste0(value, " or ", freq, " is not a tabular's column name"))
  }
  if(!is.null(maxscore)){
    if(!maxscore %in% names(tabular)){
      stop(paste0(maxscore, " is not a tabular's column name"))
    }
  }
  if(!is.null(cost_var)){
    if(!cost_var %in% names(tabular)){
      stop(paste0(cost_var, " is not a tabular's column name"))
    }
  }
  if(!is.null(secret_var)){
    if(!secret_var %in% names(tabular)){
      stop(paste0(secret_var, " is not a tabular's column name"))
    }
  }
  if(length(totcode) < length(explanatory_vars)){
    stop("totcode must have the same length as explanatory_vars")
  }
  if(length(names(totcode)) < length(explanatory_vars)){
    names(totcode) <- explanatory_vars
  }

  if(is.null(files_name)) files_name <- paste0("tau_argus_file_", format.Date(Sys.time(), format = '%Y_%m_%d_%H:%M:%S'))
  if(is.null(dir_name)) dir_name <- getwd()

  if (split_tab){
    # We want to split the table but the primary secret have not been posed
    if (!str_detect(safety_rules,"MAN")){
      stop("We using split_tab = TRUE, you can't use tauargus to pose primary secret")
    }

    # Avertize the user of default arguments being used
    cat("
When using split_tab = TRUE, according to your use,
you may want to change the following default parameters.

Current values are :
LIMIT :", LIMIT,"
nb_tab :", nb_tab,"

    ")

    # split_tab strategy only work with dimension 4 or 5 tables
    if (!length(explanatory_vars) %in% c(4,5)){
      warning("
            You use split_tab = TRUE. However it only works with table of dimension 4 or 5.
            split_tab argument is being ignored")
    }
  }

  if (length(explanatory_vars) %in% c(4,5)){
    if (split_tab){
      return(tab_rtauargus4(tabular,
                            files_name = files_name,
                            dir_name = dir_name,
                            explanatory_vars = explanatory_vars,
                            totcode = totcode,
                            hrc = hrc,
                            secret_var = secret_var,
                            secret_no_pl = secret_no_pl,
                            cost_var = cost_var,
                            value = value,
                            freq = freq,
                            ip = ip,
                            maxscore = maxscore,
                            suppress = suppress,
                            safety_rules = safety_rules,
                            show_batch_console = show_batch_console,
                            output_type = output_type,
                            output_options = output_options,
                            unif_labels = unif_labels,
                            LIMIT = LIMIT,
                            nb_tab = nb_tab,
                            ...)) # to complete later
    } else {
      cat("Warning :
It is highly recommended to use split_tab = TRUE when using rtauargus with 4 or 5 dimensions tables.
It allows to split the table in several tables with 3 dimensions.

With split_tab = FALSE, tauargus treats the table in 4 or 5 dimensions.
In this case, the secondary secret may not being optimal according to tauargus itself.")
    }
  }


  ## 1. TAB_RDA  .....................
  tabular_original <- tabular
  # uniformisation des chaines de caractères des variables catégorielles, hors total
  # tabular ......................
  if(unif_labels){
    res_unif <- uniformize_labels(tabular, explanatory_vars, hrc, totcode)
    tabular <- res_unif$data
    if(!is.null(hrc)) hrc <- res_unif$hrc_unif
  }

  # parametres
  param_tab_rda <- param_function(tab_rda, .dots)
  param_tab_rda$tabular <- tabular
  param_tab_rda$tab_filename <- file.path(dir_name, paste0(files_name, ".tab"))
  param_tab_rda$rda_filename <- file.path(dir_name, paste0(files_name, ".rda"))
  param_tab_rda$hst_filename <- if(is.null(secret_var) & is.null(cost_var)) NULL else file.path(dir_name, paste0(files_name, ".hst"))
  param_tab_rda$explanatory_vars <- explanatory_vars
  param_tab_rda$hrc <- hrc

  param_tab_rda$totcode <- totcode
  param_tab_rda$secret_var <- secret_var
  param_tab_rda$secret_no_pl <- secret_no_pl
  param_tab_rda$cost_var <- cost_var
  param_tab_rda$value <- value
  param_tab_rda$freq <- freq
  param_tab_rda$ip <- ip
  param_tab_rda$maxscore <- maxscore

  # appel (+ récuperation noms tab hst et rda)
  input <- do.call(tab_rda, param_tab_rda)


  ## 2. TAB_ARB .........................

  # parametres
  param_arb <- param_function(tab_arb, .dots)
  param_arb$tab_filename <- input$tab_filename
  param_arb$rda_filename <- input$rda_filename
  param_arb$hst_filename <- input$hst_filename
  param_arb$arb_filename <- file.path(dir_name, paste0(files_name, ".arb"))
  param_arb$output_names <- file.path(dir_name, paste0(files_name, ".csv"))
  #TODO : generaliser le choix de l'extension
  param_arb$output_type <- output_type
  param_arb$output_options <- output_options
  param_arb$explanatory_vars <- explanatory_vars
  param_arb$value <- value
  param_arb$safety_rules <- safety_rules
  param_arb$suppress <- suppress

  # appel (+ récupération nom batch)
  batch <- do.call(tab_arb, param_arb)

  ## 3. RUN_ARB ...........................

  # parametres
  param_run0 <- param_function(run_arb, .dots)
  param_system <- param_function(system, .dots)
  param_run <- c(param_run0, param_system)
  param_run$arb_filename <- param_arb$arb_filename
  param_run$logbook <- file.path(dir_name, paste0(files_name, ".txt"))
  param_run$is_tabular <- TRUE
  param_run$show_batch_console <- show_batch_console

  # appel
  res <- do.call(run_arb, param_run)

  # RESULTAT .............................
  if(output_type == 4){

    res_import <- utils::read.csv(
      param_arb$output_names,
      header = FALSE,
      col.names = c(explanatory_vars, value, freq, "Status","Dom"),
      colClasses = c(rep("character", length(explanatory_vars)), rep("numeric",2), "character", "numeric"),
      stringsAsFactors = FALSE,
      na.strings = ""
    )
    if(unif_labels){
      res_import <- cbind.data.frame(
        apply(res_import[,explanatory_vars,drop=FALSE], 2, rev_var_pour_tau_argus),
        res_import[, !names(res_import) %in% explanatory_vars]
      )
    }
    mask <- merge(tabular_original, res_import[,c(explanatory_vars,"Status")], by = explanatory_vars, all = TRUE)

    utils::write.csv(
      res_import,
      file = param_arb$output_names,
      row.names = FALSE
    )

    return(mask)

  }else{
    if(unif_labels){
      res <- cbind.data.frame(
        apply(res[,explanatory_vars,drop=FALSE], 2, rev_var_pour_tau_argus),
        res[, !names(res) %in% explanatory_vars]
      )
    }
    return(res)
  }

}

#' Wrapper of tab_rtauargus adapted for \code{tab_multi_manager} function.
#'
#' @inheritParams tab_rtauargus
#' @param ip Interval Protection Level (10 by default)
#' @param ... Other arguments of \code{tab_rtauargus} function
#'
#' @return
#' The original tabular is returned with a new
#' column called Status, indicating the status of the cell coming from Tau-Argus :
#' "A" for a primary secret due to frequency rule, "B" for a primary secret due
#' to dominance rule, "D" for secondary secret and "V" for no secret cell.
#'
#' @seealso \code{tab_rtauargus}
#'
#' @export
#'
#' @examples
#'\dontrun{
#' library(dplyr)
#' data(turnover_act_size)
#'
#' # Prepare data with primary secret ----
#' turnover_act_size <- turnover_act_size %>%
#'   mutate(
#'     is_secret_freq = N_OBS > 0 & N_OBS < 3,
#'     is_secret_dom = ifelse(MAX == 0, FALSE, MAX/TOT>0.85),
#'     is_secret_prim = is_secret_freq | is_secret_dom
#'   )
#'
#' # Make hrc file of business sectors ----
#' data(activity_corr_table)
#' hrc_file_activity <- activity_corr_table %>%
#'   write_hrc2(file_name = "hrc/activity")
#'
#' # Compute the secondary secret ----
#' options(
#'   rtauargus.tauargus_exe =
#'     "Y:/Logiciels/TauArgus/TauArgus4.2.2b1/TauArgus.exe"
#' )
#'
#' res <- tab_rtauargus2(
#'   tabular = turnover_act_size,
#'   files_name = "turn_act_size",
#'   dir_name = "tauargus_files",
#'   explanatory_vars = c("ACTIVITY", "SIZE"),
#'   hrc = c(ACTIVITY = hrc_file_activity),
#'   totcode = c(ACTIVITY = "Total", SIZE = "Total"),
#'   secret_var = "is_secret_prim",
#'   value = "TOT",
#'   freq = "N_OBS"
#' )
#' }
tab_rtauargus2 <- function(
    tabular,
    files_name = NULL,
    dir_name = NULL,
    explanatory_vars,
    totcode,
    hrc = NULL,
    secret_var = NULL,
    secret_no_pl = NULL,
    cost_var = NULL,
    value = "value",
    freq = "freq",
    ip = 10,
    suppress = "MOD(1,5,1,0,0)",
    ...
){

  .dots = list(...)

  params <- param_function(tab_rtauargus, .dots)
  params$tabular = tabular
  params$files_name = files_name
  params$dir_name = dir_name
  params$explanatory_vars = explanatory_vars
  params$totcode = totcode
  params$hrc = hrc
  params$secret_var = secret_var
  params$secret_no_pl = secret_no_pl
  params$cost_var = cost_var
  params$value = value
  params$freq = freq
  if(is.null(ip)){
    if(!"safety_rules" %in% names(params)){
      stop("Either ip or safety_rules has to be set.")
    }
  }else{
    params$safety_rules = paste0("MAN(",ip,")")
  }
  params$ip = ip
  params$suppress = suppress
  params$show_batch_console = FALSE
  params$output_type = 4
  params$output_options = ""
  params$unif_labels = TRUE
  params$separator = ","
  params$verbose = FALSE

  do.call("tab_rtauargus", params)

}
