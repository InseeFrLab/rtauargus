```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(root.dir = "Z:/rtauargus")
```

Le but de se test est de voir l'efficacité du split_table comparé au max pour voir s'il est mieux en terme de secret d'utilisé la fonction max ou la fonction split =TRUE pour le secret . 

# Librairies et source nécessaires pour les différents tests

Pour pouvoir faire ses tests, on aura besoin de différents package:
- rtauargus (pour utiliser tauargus)
- dplyr (non nécessaire mais plus pratique pour la pose du secret)
- tictoc (pour voir le temps que prends le programme)
- des sources pour l'utilisations des fonctions divisant des tables de 4 variables catégorielles en tables à 3 variables catégorielles


```{r source}
library("dplyr")
library(stringr)
library(tictoc)
# library("rtauargus")
devtools::load_all()
loc_tauargus <- "Y:/Logiciels/TauArgus/TauArgus4.2.2b1/TauArgus.exe"
options(rtauargus.tauargus_exe = loc_tauargus)

# When not knitting
setwd("Z:/rtauargus")
# Charge le fichier RData
load("data/test_4_var_2hrc_grand.RData")
```
```{r, echo = FALSE, eval = FALSE}
# When not knitting
setwd("Z:/rtauargus")

# Test everything is correctly set up
load("donnees/ca_test_0_hrc.RData")

res_all_dtp <- res_all_dtp %>%
   mutate(
     is_secret_freq = nb_obs > 0 & nb_obs < 3,
     is_secret_dom = ifelse(pizzas_max == 0, FALSE, pizzas_max/pizzas_tot>0.85),
     is_secret_prim = is_secret_freq | is_secret_dom,
     nb_obs = ceiling(nb_obs),
     pizzas_tot=abs(pizzas_tot)
   )

masque_ca_test <- tab_rtauargus(
   tabular = res_all_dtp,
   files_name = "ca_test_0_hrc",
   dir_name = "tauargus_files/ca_test_0_hrc",
   explanatory_vars = c("A10", "treff","type_distrib","cj"),
   totcode = c(A10 = "Total", treff = "Total",type_distrib = "Total",cj = "Total"),
   secret_var = "is_secret_prim",
   value = "pizzas_tot",
   freq = "nb_obs",
   nb_tab = "smart",
   split_tab = TRUE,
)

last_column_name <- names(masque_ca_test)[ncol(masque_ca_test)]

masque_ca_test <- masque_ca_test %>%
  mutate(
    statut_final = case_when(
      is_secret_freq ~ "A",
      is_secret_dom ~ "B",
      .data[[last_column_name]] ~ "D",
      TRUE ~ "V"
    ))

secret_masque_ca_test<-masque_ca_test %>% 
  group_by(statut_final) %>% 
  summarise(
    n_cell = n(),
    val_cell = sum(pizzas_tot)
  ) %>%
  mutate(
    pc_n_cell = round(n_cell/sum(n_cell)*100,1),
    pc_val_cell = round(val_cell/sum(val_cell)*100,1)
  )

print(secret_masque_ca_test)
```


# On pose le secret primaire sur la table de départ de 27000 lignes et 2 hiérarchies

Cette table ne passe sur tauargus sans split car elle est trop grande, ainsi que ses hiérarchies.

```{r pose_secret}
# When not knitting
setwd("Z:/rtauargus")

data_sp <- test_4_var_2_2hrc %>% 
  mutate(
    is_secret_freq=(nb_obs > 0 & nb_obs < 3),
    is_secret_dom = (pizzas_tot != 0) & (pizzas_max > 0.85*pizzas_tot),
    pizzas_tot= abs(pizzas_tot)
  ) %>% 
  mutate(
    is_secret_prim =  is_secret_freq ,
    nb_obs = ceiling(nb_obs)
  )

nom_table <- paste0("table_test_",3)
totcodes <- c(ACTIVITY="Total",PAYS="Total",treff="Total",cj="Total")
hrcfiles <- c(ACTIVITY= "hrc/activity_2_niv.hrc",PAYS="hrc/pays_test.hrc")

read.table(hrcfiles[["ACTIVITY"]])
```

# La table splité par rapport au min +split 

```{r min}
# When not knitting
setwd("Z:/rtauargus")

tic()
masq_liste <- tab_rtauargus( 
  tabular = data_sp,
  hrc = hrcfiles,
  totcode = totcodes,
  dir_name = "tauargus_files/Rmd_Split/min",
  files_name = "tab_min",
  explanatory_vars = names(totcodes),
  secret_var = "is_secret_prim",
  freq = "nb_obs",
  nb_tab = "min",
  value = "pizzas_tot",
  LIMIT = 12000,
  split_tab = TRUE,
)
toc()
``` 

# La table splité par rapport au max  

```{r max}
# When not knitting
setwd("Z:/rtauargus")

tic()
masq_liste2 <- tab_rtauargus( 
  tabular = data_sp,
  hrc = hrcfiles,
  totcode = totcodes,
  dir_name = "tauargus_files/Rmd_Split/max",
  files_name = "tab_max",
  explanatory_vars = names(totcodes),
  secret_var = "is_secret_prim",
  freq = "nb_obs",
  nb_tab = "max",
  value = "pizzas_tot",
  LIMIT = 12000,
  split_tab = TRUE,
)
toc()
```


# Cas extrême (non futé) : maximum de tables + slit par rapport à toutes les variables créées

```{r max_split}
# When not knitting
setwd("Z:/rtauargus")

tic()
masq_liste3 <- tab_rtauargus( 
  tabular = data_sp,
  hrc = hrcfiles,
  totcode = totcodes,
  dir_name = "tauargus_files/Rmd_Split/max_split",
  files_name = "tab_max_split",
  explanatory_vars = names(totcodes),
  secret_var = "is_secret_prim",
  freq = "nb_obs",
  nb_tab = "min",
  value = "pizzas_tot",
  LIMIT = 1,
  split_tab = TRUE,
)
toc()
``` 

# On observe les secrets posés


```{r conclusion_secret}
# First table
last_column_name <- names(masq_liste)[ncol(masq_liste)]

masq_liste <- masq_liste %>%
  mutate(
    statut_final = case_when(
      is_secret_freq ~ "A",
      is_secret_dom ~ "B",
      .data[[last_column_name]] ~ "D",
      TRUE ~ "V"
    ))

secret_min_split <- masq_liste %>% 
  group_by(statut_final) %>% 
  summarise(
    n_cell = n(),
    val_cell = sum(pizzas_tot)
  ) %>%
  mutate(
    pc_n_cell = round(n_cell/sum(n_cell)*100,1),
    pc_val_cell = round(val_cell/sum(val_cell)*100,1)
  )

# Second table
last_column_name <- names(masq_liste2)[ncol(masq_liste2)]

masq_liste2 <- masq_liste2 %>%
  mutate(
    statut_final = case_when(
      is_secret_freq ~ "A",
      is_secret_dom ~ "B",
      .data[[last_column_name]] ~ "D",
      TRUE ~ "V"
    ))

secret_max <- masq_liste2 %>% 
  group_by(statut_final) %>% 
  summarise(
    n_cell = n(),
    val_cell = sum(pizzas_tot)
  ) %>%
  mutate(
    pc_n_cell = round(n_cell/sum(n_cell)*100,1),
    pc_val_cell = round(val_cell/sum(val_cell)*100,1)
  )

# Third table
last_column_name <- names(masq_liste3)[ncol(masq_liste3)]

masq_liste3 <- masq_liste3 %>%
  mutate(
    statut_final = case_when(
      is_secret_freq ~ "A",
      is_secret_dom ~ "B",
      .data[[last_column_name]] ~ "D",
      TRUE ~ "V"
    ))

secret_max_split <- masq_liste3 %>% 
  group_by(statut_final) %>% 
  summarise(
    n_cell = n(),
    val_cell = sum(pizzas_tot)
  ) %>%
  mutate(
    pc_n_cell = round(n_cell/sum(n_cell)*100,1),
    pc_val_cell = round(val_cell/sum(val_cell)*100,1)
  )

print(secret_max)
print(secret_min_split)
print(secret_max_split)
```


